<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imusic 迷你播放器</title>
    <style>
        @import url('112233.css');
        
        body {
            margin: 0;
            padding: 0;
            width: 320px;
            height: 140px;
            background: var(--bg-main);
            color: var(--text-main);
            font-family: Arial, sans-serif;
            overflow: hidden;
            user-select: none;
            border-radius: 20px; /* 添加圆角 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* 添加阴影 */
            position: fixed;
            transition: opacity 0.2s ease;
        }
        
        .mini-player {
            display: flex;
            height: 100%;
            position: relative;
            background: var(--bg-main); /* 确保有背景 */
            border-radius: 20px; /* 添加圆角 */
        }
        
        /* 添加拖动区域 */
        .drag-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 30px;
            -webkit-app-region: drag;
            z-index: 10;
            cursor: move;
        }
        
        .album-cover-container {
            width: 90px;
            height: 90px;
            margin: 25px 10px;
            position: relative;
            flex-shrink: 0;
        }
        
        .mini-album-cover {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            background-color: var(--bg-btn);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .mini-album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .mini-album-cover.rotating {
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .player-info {
            flex: 1;
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            height: 100%;
            -webkit-app-region: no-drag; /* 使信息区域不可拖动 */
        }
        
        .song-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 5px;
        }
        
        .mini-song-title {
            font-size: 14px;
            font-weight: bold;
            margin: 0 0 3px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }
        
        .mini-lyrics {
            font-size: 12px;
            color: var(--text-sub);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 16px;
            line-height: 1.2;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            height: 35px;
        }
        
        .mini-play-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-color);
            color: var(--text-on-primary);
            border: none;
            cursor: pointer;
            cursor: url('ctmcur/Hand.cur'), pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
            transition: all 0.2s;
            -webkit-app-region: no-drag; /* 使按钮不可拖动 */
        }
        
        .mini-play-btn:hover {
            transform: scale(1.1);
        }
        
        .mini-mode-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--bg-btn);
            color: var(--text-main);
            border: none;
            cursor: pointer;
            cursor: url('ctmcur/Hand.cur'), pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
            -webkit-app-region: no-drag; /* 使按钮不可拖动 */
        }
        
        .mini-mode-btn:hover {
            transform: scale(1.1);
        }
        
        .window-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            -webkit-app-region: no-drag; /* 使窗口控制按钮不可拖动 */
        }
        
        .close-btn {
            width: 20px;
            height: 20px;
            background: transparent;
            color: var(--text-main);
            border: none;
            cursor: pointer;
            cursor: url('ctmcur/Hand.cur'), pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s;
            -webkit-app-region: no-drag; /* 使窗口控制按钮不可拖动 */
        }
        
        .close-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .close-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- 添加拖动区域 -->
    <div class="drag-area" id="dragArea"></div>
    
    <div class="mini-player">
        <div class="album-cover-container">
            <div class="mini-album-cover" id="miniAlbumCover">
                <img id="miniCoverImage" src="" alt="专辑封面" style="display: none;">
                <span id="miniCoverPlaceholder" style="color: var(--text-weak); font-size: 12px;">暂无封面</span>
            </div>
        </div>
        
        <div class="player-info">
            <div class="song-info">
                <div class="mini-song-title" id="miniSongTitle">暂无歌曲</div>
                <div class="mini-lyrics" id="miniLyrics">暂无歌词</div>
            </div>
            
            <div class="player-controls">
                <button class="mini-play-btn" id="miniPlayBtn">▶</button>
                <button class="mini-mode-btn" id="miniModeBtn" title="播放模式">列</button>
            </div>
        </div>
        
        <div class="window-controls">
            <button class="close-btn" id="closeBtn" title="关闭">✕</button>
        </div>
    </div>
    
    <script>
        const { ipcRenderer } = require('electron');
        
        // 获取DOM元素
        const miniAlbumCover = document.getElementById('miniAlbumCover');
        const miniCoverImage = document.getElementById('miniCoverImage');
        const miniCoverPlaceholder = document.getElementById('miniCoverPlaceholder');
        const miniSongTitle = document.getElementById('miniSongTitle');
        const miniLyrics = document.getElementById('miniLyrics');
        const miniPlayBtn = document.getElementById('miniPlayBtn');
        const miniModeBtn = document.getElementById('miniModeBtn');
        const closeBtn = document.getElementById('closeBtn');
        const dragArea = document.getElementById('dragArea'); // 获取拖动区域
        
        // 播放状态
        let isPlaying = false;
        let playMode = 'list'; // 默认播放模式
        
        // 播放按钮点击事件
        miniPlayBtn.addEventListener('click', () => {
            ipcRenderer.send('mini-player-control', 'toggle-play');
        });
        
        // 播放模式按钮点击事件
        miniModeBtn.addEventListener('click', () => {
            ipcRenderer.send('mini-player-control', 'change-mode');
        });
        
        // 关闭按钮点击事件
        closeBtn.addEventListener('click', () => {
            ipcRenderer.send('mini-player-control', 'close');
        });
        
        // 监听来自主窗口的播放状态更新
        ipcRenderer.on('update-mini-player-data', (event, data) => {
            if (data.songInfo) {
                const songInfo = data.songInfo;
                
                if (songInfo.isPlaying !== undefined) {
                    isPlaying = songInfo.isPlaying;
                    miniPlayBtn.textContent = isPlaying ? '❚❚' : '▶';
                    miniAlbumCover.classList.toggle('rotating', isPlaying);
                }
                
                if (songInfo.name) {
                    miniSongTitle.textContent = songInfo.name;
                    if (songInfo.artist) {
                        miniSongTitle.textContent = `${songInfo.name} - ${songInfo.artist}`;
                    }
                }
                
                if (songInfo.cover) {
                    miniCoverImage.src = songInfo.cover;
                    miniCoverImage.style.display = 'block';
                    miniCoverPlaceholder.style.display = 'none';
                } else {
                    miniCoverImage.style.display = 'none';
                    miniCoverPlaceholder.style.display = 'block';
                }
                
                if (songInfo.playMode) {
                    playMode = songInfo.playMode;
                    // 更新播放模式按钮的显示
                    switch (playMode) {
                        case 'list':
                            miniModeBtn.textContent = '列';
                            break;
                        case 'single':
                            miniModeBtn.textContent = '1';
                            break;
                        case 'random':
                            miniModeBtn.textContent = '随';
                            break;
                        default:
                            miniModeBtn.textContent = '列';
                    }
                }
            }
            
            if (data.currentLyric) {
                miniLyrics.textContent = data.currentLyric;
            }
        });
        
        // 添加拖动功能
        let isDragging = false;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        let dragStartTime;
        
        // 使用拖动区域来处理拖动事件
        dragArea.addEventListener('mousedown', dragStart);
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('mousemove', drag);
        
        function dragStart(e) {
            if (e.target === dragArea) {
                isDragging = true;
                dragStartTime = Date.now();
                // 获取初始鼠标位置
                initialX = e.clientX;
                initialY = e.clientY;
                
                // 获取当前窗口位置
                ipcRenderer.invoke('get-mini-player-position').then(pos => {
                    xOffset = pos[0];
                    yOffset = pos[1];
                });
                
                e.preventDefault();
            }
        }
        
        function dragEnd(e) {
            if (isDragging) {
                isDragging = false;
            }
        }
        
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                const currentX = e.clientX - initialX;
                const currentY = e.clientY - initialY;
                
                const newX = xOffset + currentX;
                const newY = yOffset + currentY;
                
                // 通过IPC移动窗口
                ipcRenderer.send('set-mini-player-position', Math.round(newX), Math.round(newY));
            }
        }
        
        // 初始化时请求当前播放状态
        ipcRenderer.send('request-mini-player-data');
        
        // 应用主题设置
        function applyTheme() {
            const isLightTheme = localStorage.getItem('theme') === 'light';
            document.body.classList.toggle('light', isLightTheme);
        }
        
        // 初始化主题
        applyTheme();
        
        // 监听主题变化
        window.addEventListener('storage', (e) => {
            if (e.key === 'theme') {
                applyTheme();
            }
        });
    </script>
</body>
</html>